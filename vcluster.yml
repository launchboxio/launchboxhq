globalAnnotations:
  "launchboxhq.io/project-id": "<%= @project.id %>"
vcluster:
  extraArgs:
    - "--kube-apiserver-arg=--oidc-username-claim=preferred_username"
    - "--kube-apiserver-arg=--oidc-issuer-url=<%= Rails.configuration.launchbox[:vcluster][:oidc_issuer_url] %>"
    - "--kube-apiserver-arg=--oidc-client-id=<%= @oidc_client_id %>"
    - "--kube-apiserver-arg=--oidc-username-claim=email"
    - "--kube-apiserver-arg=--oidc-groups-claim=groups"
  resources:
    limits:
      cpu: <%= @project.cpu %>
      memory: "<%= @project.memory %>Mi"

storage:
  persistence: true
  size: "<%= @project.disk %>Gi"
sync:
  ingresses:
    enabled: true
  serviceaccounts:
    enabled: true
ingress:
  enabled: true
  ingressClassName: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: HTTPS
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  host: "api.<%= @project.slug %>.<%= Rails.configuration.launchbox[:vcluster][:cluster_domain] %>"

init:
  manifests: |
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: admins
    subjects:
    - kind: User
      name: <%= @project.user.email %>
      apiGroup: rbac.authorization.k8s.io
    roleRef:
      kind: ClusterRole
      name: cluster-admin
      apiGroup: rbac.authorization.k8s.io
